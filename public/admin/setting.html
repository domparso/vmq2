<div class="layui-form" action="">

    <div class="layui-form-item">
        <label class="layui-form-label">后台账号</label>
        <div class="layui-input-block">
            <input type="text" id="user" lay-verify="required" placeholder="请输入管理员账号" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">后台密码</label>
        <div class="layui-input-block">
            <input type="text" id="pass" lay-verify="required" placeholder="请输入管理员密码" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">首页跳转地址</label>
        <div class="layui-input-block">
            <input type="text" id="jump" lay-verify="required" placeholder="请输入首页跳转地址" autocomplete="off" class="layui-input">
        </div>
    </div>
    
    <div class="layui-form-item">
        <label class="layui-form-label">邮箱</label>
        <div class="layui-input-block">
            <input type="text" id="email" lay-verify="required" placeholder="请输入邮箱" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">支付宝商户号</label>
        <div class="layui-input-block">
            <input type="text" id="alipayId" placeholder="请输入支付宝商户号，留空就是收款码" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">转账类型</label>
        <div class="layui-input-block">
            <input type="radio" name="transfer" title="个人转账" value="1" id="transfer-1"><div class="layui-unselect layui-form-radio layui-form-radioed"><i class="layui-anim layui-icon"></i><span>个人转账</span></div> 
            <input type="radio" name="transfer" title="扫码转账" value="2" id="transfer-2"><div class="layui-unselect layui-form-radio layui-form-radioed"><i class="layui-anim layui-icon"></i><span>扫码转账</span></div> 
            <input type="radio" name="transfer" title="关闭" value="0" id="transfer-0"><div class="layui-unselect layui-form-radio layui-form-radioed"><i class="layui-anim layui-icon"></i><span>关闭</span></div> 
            <span style="vertical-align: sub;">说明：个人转账不支持APP监控，关闭后就是收款码</span>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">支付宝订单确认页</label>
        <div class="layui-input-block">
            <input type="radio" name="confirm" title="关闭" value="0" id="confirm-0"><div class="layui-unselect layui-form-radio layui-form-radioed"><i class="layui-anim layui-icon"></i><span>关闭</span></div> 
            <input type="radio" name="confirm" title="开启" value="1" id="confirm-1"><div class="layui-unselect layui-form-radio layui-form-radioed"><i class="layui-anim layui-icon"></i><span>开启</span></div> 
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">语音播报</label>
        <div class="layui-input-block">
            <input type="radio" name="voice" title="关闭" value="0" id="voice-0"><div class="layui-unselect layui-form-radio layui-form-radioed"><i class="layui-anim layui-icon"></i><span>关闭</span></div> 
            <input type="radio" name="voice" title="开启" value="1" id="voice-1"><div class="layui-unselect layui-form-radio layui-form-radioed"><i class="layui-anim layui-icon"></i><span>开启</span></div> 
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">支付时间间隔</label>
        <div class="layui-input-block">
            <input type="text" id="timeInterval" placeholder="请输入支付时间间隔，无限制留空，单位：秒" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">最多待支付订单</label>
        <div class="layui-input-block">
            <input type="text" id="payNum" placeholder="请输入同一ip最多待支付订单，无限制留空" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">最多提交补单次数</label>
        <div class="layui-input-block">
            <input type="text" id="bdNum" placeholder="请输入同一ip最多提交补单次数，无限制留空" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">订单有效期</label>
        <div class="layui-input-block">
            <input type="number" id="close" lay-verify="required" placeholder="请输入创建的订单几分钟后失效" autocomplete="off" class="layui-input">
        </div>
    </div>

    <!--<div class="layui-form-item">
        <label class="layui-form-label">异步回调</label>
        <div class="layui-input-block">
            <input type="text" id="notifyUrl" lay-verify="required" placeholder="请输入异步回调地址" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">同步回调</label>
        <div class="layui-input-block">
            <input type="text" id="returnUrl" lay-verify="required" placeholder="请输入支付完成后跳转地址" autocomplete="off" class="layui-input">
        </div>
    </div>-->

    <div class="layui-form-item">
        <label class="layui-form-label">商户ID</label>
        <div class="layui-input-block">
            <input type="text" id="pid" lay-verify="required" placeholder="请输入商户ID" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">通讯密钥</label>
        <div class="layui-input-block">
            <input type="text" id="key" lay-verify="required" placeholder="请输入通讯密钥" autocomplete="off" class="layui-input" readonly="readonly">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">区分方式</label>
        <div class="layui-input-block">
            <div class="layui-upload">
                <select id="payQf">
                    <option value="1">金额递增</option>
                    <option value="2">金额递减</option>
                </select>
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">微信码</label>
        <div class="layui-input-block">
            <div class="layui-upload">
                <button type="button" class="layui-btn" id="wxup">上传收款二维码</button>（此处上传的是无金额的收款二维码）
                <div class="layui-upload-list">
                    <img class="layui-upload-img" id="wximg">
                    <p id="wxcs"></p>
                </div>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">支付宝码</label>
        <div class="layui-input-block">
            <div class="layui-upload">
                <button type="button" class="layui-btn" id="zfbup">上传收款二维码</button>（此处上传的是无金额的收款二维码）
                <div class="layui-upload-list">
                    <img class="layui-upload-img" id="zfbimg">
                    <p id="zfbcs"></p>
                </div>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">QQ码</label>
        <div class="layui-input-block">
            <div class="layui-upload">
                <button type="button" class="layui-btn" id="qqup">上传收款二维码</button>（此处上传的是无金额的收款二维码）
                <div class="layui-upload-list">
                    <img class="layui-upload-img" id="qqimg">
                    <p id="qqcs"></p>
                </div>
            </div>
        </div>
    </div>


    <div class="layui-form-item" style="text-align: right;">
        <button class="layui-btn" onclick="save()">保存</button>
    </div>



    <!--<div class="layui-form-item layui-form-text">-->
    <!--<label class="layui-form-label">设置进入网站的提示</label>-->
    <!--<div class="layui-input-block">-->
    <!--<textarea placeholder="请输入公告内容" id="xz" class="layui-textarea"></textarea>-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="layui-form-item">-->
    <!--<button class="layui-btn" onclick="editxz()">保存</button>-->
    <!--</div>-->
</div>

<script>
    function formatDate(now) {
        now = new Date(now*1000);
        return now.getFullYear()
            + "-" + (now.getMonth()>8?(now.getMonth()+1):"0"+(now.getMonth()+1))
            + "-" + (now.getDate()>9?now.getDate():"0"+now.getDate())
            + " " + (now.getHours()>9?now.getHours():"0"+now.getHours())
            + ":" + (now.getMinutes()>9?now.getMinutes():"0"+now.getMinutes())
            + ":" + (now.getSeconds()>9?now.getSeconds():"0"+now.getSeconds());

    }
    layui.use(['form','layer','upload'], function(){
        var table = layui.table,form = layui.form,upload = layui.upload;

        var uploadInst = upload.render({
            elem: '#wxup'
            , url: 'qr-code/test.php'
            ,auto: false
            ,choose: function(obj){
                // console.log(obj)
                obj.preview(function(index, file, result){
                    qrcode.decode(getObjectURL(file));
                    qrcode.callback = function(imgMsg) {
                        console.log(imgMsg)
                        if(imgMsg!=""){
                            $('#wximg').attr('src', "enQrcode?url="+imgMsg);
                        }else{
                            layer.msg('处理中', {
                                icon: 16
                                ,shade: 0.01
                                ,time:0
                            });

                            $.post("qr-code/test.php","base64="+encodeURIComponent(result.split(",")[1]),function (data) {
                                console.log(data)
                                if (!data.data) {
                                    data = JSON.parse(data);
                                }
                                if (data.code==1){
                                    $('#wximg').attr('src', "enQrcode?url="+data.data);
                                    layer.msg('处理成功');
                                } else{
                                    return layer.alert('处理失败，可以尝试将二维码用草料识别出内容，然后重新将内容生成二维码图片上传！');
                                }

                            });
                        }
                    }
                });

            }
            , before: function (obj) {
                layer.msg('处理中', {
                    icon: 16
                    ,shade: 0.01
                    ,time:0
                });
            }
            , done: function (res) {
                //如果上传失败
                if (res.code == -1) {
                    return layer.msg('上传失败');
                }
                if (res.data==""){
                    return layer.msg('请上传微信无金额收款二维码');
                }
                layer.msg('处理成功');

                $('#wximg').attr('src', "enQrcode?url="+res.data);
            }
            , error: function () {
                layer.msg('上传失败');
                //演示失败状态，并实现重传
                var demoText = $('#wxcs');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs wxcs">重试</a>');
                demoText.find('.wxcs').on('click', function () {
                    uploadInst.upload();
                });
            }
        });
        
        var uploadInst2 = upload.render({
            elem: '#zfbup'
            , url: 'qr-code/test.php'
            ,auto: false
            ,choose: function(obj){
                console.log(obj)
                obj.preview(function(index, file, result){
                    qrcode.decode(getObjectURL(file));
                    qrcode.callback = function(imgMsg) {
                        console.log(imgMsg)
                        if(imgMsg!=""){
                            $('#zfbimg').attr('src', "enQrcode?url="+imgMsg);
                        }else{
                            layer.msg('处理中', {
                                icon: 16
                                ,shade: 0.01
                                ,time:0
                            });
                            $.post("qr-code/test.php","base64="+encodeURIComponent(result.split(",")[1]),function (data) {
                                console.log(data)
                                if (!data.data) {
                                    data = JSON.parse(data);
                                }
                                if (data.code==1){
                                    $('#zfbimg').attr('src', "enQrcode?url="+data.data);
                                    layer.msg('处理成功');
                                } else{
                                    return layer.alert('处理失败，可以尝试将二维码用草料识别出内容，然后重新将内容生成二维码图片上传！');

                                }

                            });
                        }
                    }
                });

            }
            , before: function (obj) {
                layer.msg('处理中', {
                    icon: 16
                    ,shade: 0.01
                    ,time:0
                });
            }
            , done: function (res) {
                //如果上传失败
                if (res.code == -1) {
                    return layer.msg('上传失败');
                }
                if (res.data=="" ){
                    return layer.msg('请上传支付宝无金额收款二维码');
                }
                layer.msg('处理成功');

                $('#zfbimg').attr('src', "enQrcode?url="+res.data);
            }
            , error: function () {
                layer.msg('上传失败');

                //演示失败状态，并实现重传
                var demoText = $('#zfbcs');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs zfbcs">重试</a>');
                demoText.find('.zfbcs').on('click', function () {
                    uploadInst2.upload();
                });
            }
        });
        
        var uploadInst3 = upload.render({
            elem: '#qqup'
            , url: 'qr-code/test.php'
            ,auto: false
            ,choose: function(obj){
                console.log(obj)
                obj.preview(function(index, file, result){
                    qrcode.decode(getObjectURL(file));
                    qrcode.callback = function(imgMsg) {
                        // console.log(imgMsg)
                        if(imgMsg!=""){
                            imgMsg = imgMsg.replace(/tenpa/,"tenpay");
                            $('#qqimg').attr('src', "enQrcode?url="+encodeURIComponent(imgMsg));
                        }else{
                            layer.msg('处理中', {
                                icon: 16
                                ,shade: 0.01
                                ,time:0
                            });
                            $.post("qr-code/test.php","base64="+encodeURIComponent(result.split(",")[1]),function (data) {
                                console.log(data)
                                if (!data.data) {
                                    data = JSON.parse(data);
                                }
                                if (data.code==1){
                                    imgMsg = data.data.replace(/tenpa/,"tenpay");
                                    $('#qqimg').attr('src', "enQrcode?url="+encodeURIComponent(imgMsg));
                                    layer.msg('处理成功');
                                } else{
                                    return layer.alert('处理失败，可以尝试将二维码用草料识别出内容，然后重新将内容生成二维码图片上传！');

                                }

                            });
                        }
                    }
                });

            }
            , before: function (obj) {
                layer.msg('处理中', {
                    icon: 16
                    ,shade: 0.01
                    ,time:0
                });
            }
            , done: function (res) {
                //如果上传失败
                if (res.code == -1) {
                    return layer.msg('上传失败');
                }
                if (res.data=="" ){
                    return layer.msg('请上传支付宝无金额收款二维码');
                }
                layer.msg('处理成功');
                imgMsg = res.data.replace(/tenpa/,"tenpay");
                $('#qqimg').attr('src', "enQrcode?url="+encodeURIComponent(imgMsg));
            }
            , error: function () {
                layer.msg('上传失败');

                //演示失败状态，并实现重传
                var demoText = $('#qqcs');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs qqcs">重试</a>');
                demoText.find('.qqcs').on('click', function () {
                    uploadInst3.upload();
                });
            }
        });
        
        form.render();

    });



    function save() {
        var user = $("#user").val();
        var pass = $("#pass").val();
        var notifyUrl = $("#notifyUrl").val();
        var returnUrl = $("#returnUrl").val();
        var key = $("#key").val();
        var close = $("#close").val();
        var payQf = $("#payQf").val();
        var pid = $('#pid').val();
        var email = $('#email').val();
        var alipayId = $('#alipayId').val();
        var timeInterval = $('#timeInterval').val();
        var payNum = $('#payNum').val();
        var bdNum = $('#bdNum').val();
        var jump = $('#jump').val();
        var transfer = $('[name="transfer"]:checked').val();
        var confirm = $('[name="confirm"]:checked').val();
        var voice = $('[name="voice"]:checked').val();
        if (user == ""){
            layer.msg("请输入管理员账号");
            return;
        }
        /*if (pass == ""){
            layer.msg("请输入管理员密码");
            return;
        }*/
        var pattern = /^[0-9]*$/;
        if (pid == ""){
            layer.msg("请输入商户ID");
            return;
        }else if(!pattern.test(pid)){
            layer.msg("商户ID必须是数字");
            return;
        }
        if (key == ""){
            layer.msg("请输入通讯密钥");
            return;
        }
        if(email == ''){
            layer.msg("请输入邮箱");
            return;
        }
        /*if (notifyUrl == ""){
            layer.msg("请输入异步回调地址");
            return;
        }
        if (returnUrl == ""){
            layer.msg("请输入支付完成后跳转地址");
            return;
        }*/

        if (close == ""){
            layer.msg("请输入创建的订单几分钟后失效");
            return;
        }
        /*var wximg = $("#wximg").attr("src");
        if (wximg=="" || !wximg){
            layer.msg("请上传微信无金额的收款二维码");
            return;
        }
        var zfbimg = $("#zfbimg").attr("src");
        if (zfbimg=="" || !zfbimg){
            layer.msg("请上传支付宝无金额的收款二维码");
            return;
        }
        var qqimg = $("#qqimg").attr("src");
        if (!qqimg){
            layer.msg("请上传QQ无金额的收款二维码");
            return;
        }*/
        var wximg = $("#wximg").attr("src");
        var zfbimg = $("#zfbimg").attr("src");
        var qqimg = $("#qqimg").attr("src");
        
        if(wximg){
            wximg = wximg.replace(/enQrcode\?url=/g,"");
        }else{
            wximg = '';
        }
        if(zfbimg){
            zfbimg = zfbimg.replace(/enQrcode\?url=/g,"");
        }else{
            zfbimg = '';
        }
        if(qqimg){
            qqimg = qqimg.replace(/enQrcode\?url=/g,"");
        }else{
            qqimg = '';
        }

        $.post("admin/index/saveSetting","user="+user+"&pass="+pass+"&notifyUrl="+notifyUrl+"&returnUrl="+returnUrl+"&key="+key+"&wxpay="+wximg+"&zfbpay="+zfbimg+"&close="+close+"&payQf="+payQf+"&pid="+pid+'&email='+email+'&alipayId='+alipayId+'&timeInterval='+timeInterval+'&payNum='+payNum+'&bdNum='+bdNum+'&qqpay='+qqimg+"&jump="+jump+"&transfer="+transfer+"&confirm="+confirm+"&voice="+voice,function (data) {
            if (data.code==1){
                $.post("admin/index/getSettings",function (data) {
                    getstate();
                });
            }
            layer.msg(data.msg);
        });
    }


    function getstate(){
        $.post("admin/index/getSettings",function (data) {
            // console.log(data);
            if (data.code==1){
                $("#user").val(data.data.user);
                // $("#pass").val(data.data.pass);
                $("#notifyUrl").val(data.data.notifyUrl);
                $("#returnUrl").val(data.data.returnUrl);
                $("#key").val(data.data.key);
                $("#close").val(data.data.close);
                $("#payQf").val(data.data.payQf);
                $("#pid").val(data.data.pid);
                $('#email').val(data.data.email);
                $('#alipayId').val(data.data.alipayId);
                $('#timeInterval').val(data.data.timeInterval);
                $('#payNum').val(data.data.payNum);
                $('#bdNum').val(data.data.bdNum);
                $("#jump").val(data.data.jump);
                $('#transfer-'+data.data.transfer).next().click();
                $('#confirm-'+data.data.confirm).next().click();
                $('#voice-'+data.data.voice).next().click();

                if (data.data.wxpay!=""){
                    $('#wximg').attr('src', "enQrcode?url="+data.data.wxpay);
                }
                if (data.data.zfbpay!=""){
                    $('#zfbimg').attr('src', "enQrcode?url="+data.data.zfbpay);
                }
                if (data.data.qqpay){
                    $('#qqimg').attr('src', "enQrcode?url="+encodeURIComponent(data.data.qqpay));
                }
                layui.form.render();


            }
        });
    }
    getstate();
</script>